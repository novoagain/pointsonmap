<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>Geo | basic template</title>
    <script src="https://d3js.org/d3.v5.js"></script>
    <!--script type="text/javascript" src="http://d3js.org/topojson.v0.min.js"></script-->
    <!--script type="text/javascript" src="http://d3js.org/topojson.v1.min.js"></script-->
    <script src="https://unpkg.com/topojson-client@3"></script>
    <script type="text/javascript" src="https://raw.githubusercontent.com/mathiasbynens/windows-1251/master/src/windows-1251.js"></script>
</head>

<style>

    body {
        font: 10px Arial;
    }

    /* lines format */
    path {
        stroke: #a9a9a9;
        stroke-width: 1px;
    }

    /* regions format */
    .region {
        fill: #d6d6d6
    }
</style>

<body>

<script type="text/javascript">
    //map's frame
    var width = 1550,
        height = 800;

    //adding rectangle for map
    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)
        .style("margin", "10px auto");

    //creating projection for Russia
    var projection = d3.geoAlbers()//conic projection
        .rotate([-105, 0])//rotating sphere, negative values show eastern hemisphere
        .center([-10, 65])//map center's longitude and latitude
        .parallels([52, 64])//two base parallels
        .scale(1100)//simple zoom
        .translate([width / 2, height / 2]);//map centre in pixels

    var path = d3.geoPath().projection(projection);

    d3.json("https://gist.githubusercontent.com/novoagain/1ba16ed97ba8dc23b59b2c4360194f28/raw/c2065c611da23651a5c65c74980f56a6643d2cd1/Russia_simplified_topo.json").then(map => {

           //Drawing Choropleth
            var m = svg.append("g")
                .attr("class", "region")
                //.attr("fill", "#d6d6d6")//region color setting
                .selectAll("path")//linking to borders data with coordinates
                //.data(map.features); // <-- for geojson
                //.data(topojson.object(map, map.objects.yes1).geometries); // <-- for old topojson
                .data(topojson.feature(map, map.objects.yes1).features); // <-- for topojson.v1.js or last unpkg ver

                m.enter()
                .append("path")
                    .attr("class", "border")
                    //.attr("stroke", "#a9a9a9")//borders color setting
                .attr("d", path);

    }).then(function drawpoints() {
	fetch("https://raw.githubusercontent.com/novoagain/pointsonmap/master/data/cities_tsv.txt?token=AJWZXM7GSHH45D4TYJ3BWQS46TFT6").then(cities => {
		return cities.arrayBuffer();
	}).then(buffer => {
		result = '';
		
		//Making new 8 bit array from buffer, go through each element and concatenating values
		var str = new Uint8Array(buffer).forEach(byte => result += String.fromCharCode(byte));
		
		//Applying win-1251.js library
		return windows1251.decode(result);
	}).then(str_fin => {
		return d3.tsvParse(str_fin);
	}).then(cities_arr => {
		//console.log(cities_arr);
		
		var city = svg.selectAll("g.city")
			.data(cities_arr)
			.enter().append("g")
			.attr("class", "city")
			.attr("transform", function(d) { return "translate(" + projection([d.lon, d.lat]) + ")";});
		
		city.append("circle")
			.attr("r", 2)
			.style("fill", "#0173C6");
		
		city.append("text")
			.attr("x", 5)
			.text(function(d) {return d.city;});
	});
    });


</script>
</body>
</html>
